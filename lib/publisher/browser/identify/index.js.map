{"version":3,"file":"index.js","sources":["../../../../src/publisher/browser/identify/index.ts"],"sourcesContent":["/* eslint-env browser */\n\nimport __CSS__ from './style.js';\n\ntype StopIdentifyMessage = { op: 'stop-identify' };\ntype AddPublisherMessage = { op: 'add-publisher'; id: string; name: string };\ntype Message = StopIdentifyMessage | AddPublisherMessage;\n\nconst identifyWidgetId = 'rempl-identify-widget';\nlet cancelOverlay: (() => void) | null = null;\n\nfunction createOverlay(origin: string, num: string) {\n    const overlayEl = document.createElement('div');\n    const shadow = overlayEl.attachShadow({ mode: 'closed' });\n    const styleEl = document.createElement('style');\n    const buttonsEl = document.createElement('div');\n    const headerEl = document.createElement('h1');\n\n    overlayEl.id = identifyWidgetId;\n    overlayEl.dataset.origin = origin;\n    headerEl.textContent = num;\n    styleEl.textContent = __CSS__;\n\n    shadow.append(styleEl, headerEl, buttonsEl);\n\n    return {\n        overlayEl,\n        createButton(name: string, pickPublisher: () => void) {\n            const wrapperEl = buttonsEl.appendChild(document.createElement('div'));\n            const buttonEl = wrapperEl.appendChild(document.createElement('button'));\n\n            wrapperEl.setAttribute('style', 'margin-bottom:5px');\n\n            buttonEl.textContent = name;\n            buttonEl.addEventListener('click', pickPublisher);\n        },\n    };\n}\n\nexport function postIdentifyMessage(params: Message) {\n    postMessage({ to: identifyWidgetId, ...params });\n}\n\nexport function startIdentify(\n    origin: string,\n    num: number | string,\n    callback: (publisherId: string) => void\n) {\n    if (typeof document === 'undefined') {\n        return;\n    }\n\n    const existingWidget = document.querySelector('#' + identifyWidgetId);\n\n    if (!existingWidget || (existingWidget as HTMLElement).dataset.origin !== origin) {\n        if (existingWidget) {\n            postMessage({ op: 'stop-identify' });\n        }\n\n        const { overlayEl, createButton } = createOverlay(origin, String(num));\n\n        const documentStyleOverflow = document.body.style.overflow;\n        document.body.style.overflow = 'hidden';\n        document.body.appendChild(overlayEl);\n\n        const onMessageCallback = (\n            event: MessageEvent<Message & { to: typeof identifyWidgetId }>\n        ) => {\n            const { data } = event;\n\n            if (data?.to === identifyWidgetId) {\n                switch (data.op) {\n                    case 'add-publisher':\n                        createButton(data.name || data.id, () => callback(data.id));\n                        break;\n\n                    case 'stop-identify':\n                        console.log('stop-indentify');\n                        cancelOverlay?.();\n                        break;\n                }\n            }\n        };\n\n        addEventListener('message', onMessageCallback);\n\n        cancelOverlay = () => {\n            removeEventListener('message', onMessageCallback);\n            document.body.style.overflow = documentStyleOverflow;\n            overlayEl.remove();\n            cancelOverlay = null;\n        };\n    }\n}\n\nexport function stopIdentify() {\n    if (typeof cancelOverlay === 'function') {\n        cancelOverlay();\n    }\n}\n"],"names":[],"mappings":"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"}